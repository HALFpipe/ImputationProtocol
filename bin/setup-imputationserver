#!/bin/bash

verbose=1

run_cmd() {
    cmd="$*"

    printf '%s\n' --------------------

    if [ "${verbose}" = "1" ]; then
        printf "%s\n" "${cmd}"
    fi

    ("$@")

    EXIT_CODE=$?

    if [[ $EXIT_CODE -gt 0 ]]; then
        echo "ERROR: command exited with nonzero status $EXIT_CODE"
    fi

    printf '%s\n' --------------------

    return $EXIT_CODE
}

# code starts here

run_cmd mkdir -p -v /data/cloudgene /data/downloads
run_cmd cp -rnv /opt/cloudgene/* /data/cloudgene/

export PATH=/data/cloudgene:${PATH}
export HADOOP_CONF_DIR=/data/hadoop/config

run_cmd cloudgene verify-cluster

imputationserver_version="1.7.3"
if [ ! -f /data/cloudgene/apps/imputationserver/${imputationserver_version}/imputationserver.jar ]; then
    run_cmd wget --continue \
        -O "/data/downloads/imputationserver-${imputationserver_version}.zip" \
        "https://github.com/genepi/imputationserver/releases/download/v${imputationserver_version}/imputationserver.zip"
    run_cmd cloudgene install /data/downloads/imputationserver-${imputationserver_version}.zip
fi

reference_version="3.0.0"
if [ ! -f /data/cloudgene/apps/1000g-phase-3-v5/${reference_version}/imputation-1000genomes-phase3.yaml ]; then
    run_cmd cloudgene install /localdata/imputationserver/1000genomes-phase3.zip
fi

run_cmd "sed -i \"s/value: auto/value: password/g\" /data/cloudgene/apps/imputationserver/*/*.yaml"

run_cmd find /data/cloudgene/apps -type d -exec chmod ugo+w {} + # need to be writable because it will be used as a temp dir
run_cmd find /data/cloudgene/apps -type f -exec chmod ugo-w {} + # should not be writable, or cloudgene will delete the files after import to hadoop hdfs

run_cmd mkdir -p -v /data/input /data/output
